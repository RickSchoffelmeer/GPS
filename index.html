<!DOCTYPE html>
<html lang="en">
<head>
	
	<title>Marker Finder</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
    <link  rel="stylesheet" href="https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css"/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <script src="https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js"></script>

	<style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
	</style>
</head>
<body>

<div id="map"></div>

<script>
    L.mapbox.accessToken = 'pk.eyJ1IjoicnNjaG9mZmVsbWVlciIsImEiOiJjbDMxaXR5MnQwMDBxM2NvZm5jN2Jlbzl6In0.fL0gv8xa5CQlMJHVZ6Rp-A';

	var newlocationCircle;
	var newlocationMarker;
	var curlocationCircle;
	var curlocationMarker;
    var radiusFilter = 100;
    var filterCircle = newlocationMarker, radiusFilter;

	var map = L.map('map').fitWorld();

    L.mapbox.accessToken = 'pk.eyJ1IjoicnNjaG9mZmVsbWVlciIsImEiOiJjbDMxaXR5MnQwMDBxM2NvZm5jN2Jlbzl6In0.fL0gv8xa5CQlMJHVZ6Rp-A';
    var map = L.mapbox.map('map')
        .setView([53.201233, 5.799913], 12)
        .addLayer(L.mapbox.styleLayer('mapbox://styles/mapbox/outdoors-v11'));

    var csvLayer = omnivore.csv('eventMarkers.csv', null, L.mapbox.featureLayer()).addTo(map);

	function onLocationFound(e) {
		
		if (curlocationMarker != null){
		map.removeLayer(curlocationCircle);
		map.removeLayer(curlocationMarker);
		}

		var radius = e.accuracy / 2;

		newlocationMarker = L.marker(e.latlng);

		newlocationCircle = L.circle(e.latlng, radius);
		
		map.addLayer(newlocationMarker);
		map.addLayer(newlocationCircle);
		
		curlocationMarker = newlocationMarker;
		curlocationCircle = newlocationCircle;
	}

	function onLocationError(e) {
		alert(e.message);
	}

	//function checkMarkerFound(e) {
	//	filterCircle.setLatLng(e.latlng);
    //    csvLayer.setFilter(function showEvents(feature) {
    //    return e.latlng.distanceTo(L.latLng(
    //            feature.geometry.coordinates[1],
    //            feature.geometry.coordinates[0])) < radiusFilter;
    //});
	//}

    map.on('locationfound', onLocationFound);
    map.on('locationfound', function(e) {
    filterCircle.setLatLng(e.latlng);
    csvLayer.setFilter(function showEvents(feature) {
        return e.latlng.distanceTo(L.latLng(
                feature.geometry.coordinates[1],
                feature.geometry.coordinates[0])) < radiusFilter;
    });
});
	map.on('locationerror', onLocationError);

	map.locate({setView: true, watch: true});
</script>
</body>
</html>
